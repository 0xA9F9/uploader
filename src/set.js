import{ref as e,reactive as l,onMounted as a,onUnmounted as t}from"vue";import{db as r}from"./firebase.js";import o from"axios";import n from"canvas-confetti";let DELETION_TIME_SECONDS=45,DELETION_TIME_MS=45e3;export default function u(){let u=e(""),i=e(""),s=e(""),v=e(""),c=e(""),d=e(!1),$=e(""),g=e(!1),f=e([]),p=e([]),m=e([]),h=e(!1),k=e(0),_=e(!0),T=e(0),y=null,w=null,b=null,x=l({tokenInfo:!1,accountWhy:!1,comment:!1,delete:!1,feedback:!1});function S(e,l,a){let t=new Date;t.setTime(t.getTime()+864e5*a),document.cookie=e+"="+encodeURIComponent(l)+";expires="+t.toUTCString()+";path=/"}function E(e){let l=`; ${document.cookie}`,a=l.split(`; ${e}=`);return 2===a.length?decodeURIComponent(a.pop().split(";").shift()):null}function I(e){document.cookie=e+"=; Max-Age=0; path=/"}let z=(e,l)=>{v.value=e,c.value=l,"warning"!==l&&setTimeout(()=>{v.value="",c.value=""},3e3)},C=e=>{let l=e.currentTarget,{left:a,top:t,width:r,height:o}=l.getBoundingClientRect(),u=(a+r/2)/window.innerWidth,i=(t+o/2)/window.innerHeight;n({particleCount:100,spread:70,startVelocity:30,angle:90,origin:{x:u,y:i},disableForReducedMotion:!0})};function M(e,l){if(l.created){let a=new Date(l.created).getTime(),t=Date.now(),o=Math.floor((t-a)/1e3),n=45-o;if(console.log("initializeDeletionTimer: elapsed =",o,"remaining =",n),n<=0){console.log("Время истекло. Проводим проверку для удаления токена",e),r.ref("tokens/"+e+"/uploaded").once("value").then(l=>{0===l.numChildren()&&r.ref("tokens/"+e).remove().then(()=>{console.log("Token",e,"удалён сразу, так как время истекло"),u.value===e&&Q(),z("Токен удалён из-за отсутствия загрузок","error")}).catch(e=>{console.error("Ошибка при удалении токена",e)})}).catch(e=>{console.error("Ошибка при получении данных uploaded",e)});return}l.uploaded&&0!==Object.keys(l.uploaded).length?console.log("Загрузки уже есть – таймер не запускается."):(T.value=n,w||(w=setInterval(()=>{T.value--,T.value<=0&&(clearInterval(w),w=null)},1e3)),b||(b=setTimeout(()=>{console.log("deletionTimeout сработал для токена",e),r.ref("tokens/"+e+"/uploaded").once("value").then(l=>{0===l.numChildren()?r.ref("tokens/"+e).remove().then(()=>{console.log("Token",e,"удалён после истечения времени"),u.value===e&&Q(),z("Токен удалён из-за отсутствия загрузок","error")}).catch(e=>{console.error("Ошибка при удалении токена",e)}):console.log("Удаление не производится, т.к. найдены загрузки")}).catch(e=>{console.error("Ошибка при получении данных uploaded",e)})},1e3*n)))}}function O(e){let l=r.ref("tokens/"+e+"/uploaded");f.value=[],l.off("child_added"),l.on("child_added",e=>{let l={firebaseKey:e.key,...e.val()};f.value.find(l=>l.firebaseKey===e.key)||(f.value.push(l),1!==f.value.length||(w&&(clearInterval(w),w=null),b&&(clearTimeout(b),b=null),z("Первая загрузка получена. Таймер удаления отменён.","success"),T.value=0))})}a(()=>{y=setInterval(()=>{_.value=!_.value},3e3);let e=E("userToken");if(e){u.value=e,i.value=e,d.value=!0,z("обновлено","success");let l=r.ref("tokens/"+e);l.on("value",l=>{if(l.exists()){let a=l.val();s.value=a.avatar,M(e,a)}else d.value=!1,I("userToken"),z("Токен не найден, авторизация завершена","error")}),O(e)}}),t(()=>{clearInterval(y);let e=E("userToken");e&&(r.ref("tokens/"+e).off(),r.ref("tokens/"+e+"/uploaded").off()),w&&clearInterval(w),b&&clearTimeout(b)});let B=async e=>{C(e);let l=Math.random().toString(36).substring(2,10)+Date.now(),a=["/assets/img/JoQoK.png","/assets/img/VfhwY.png","/assets/img/DhYgs.png","/assets/img/OzHsz.png","/assets/img/QzJsH.png",],t=a[Math.floor(Math.random()*a.length)];try{await r.ref("tokens/"+l).set({created:new Date().toISOString(),avatar:t}),u.value=l,i.value=l,g.value=!0,z("токен успешно сгенерирован.","success"),S("userToken",l,30),d.value=!0,s.value=t;let o=r.ref("tokens/"+l);o.on("value",e=>{if(e.exists()){let l=e.val();s.value=l.avatar}}),O(l),T.value=45,w=setInterval(()=>{T.value--,T.value<=0&&(clearInterval(w),w=null)},1e3),b=setTimeout(()=>{console.log("deletionTimeout triggered for token",l),r.ref("tokens/"+l+"/uploaded").once("value").then(e=>{0===e.numChildren()?r.ref("tokens/"+l).remove().then(()=>{console.log("Token",l,"removed successfully"),u.value===l&&Q(),z("Токен удалён из-за отсутствия загрузок","error")}).catch(e=>{console.error("Ошибка при удалении токена",e)}):console.log("Удаление не производится, т.к. найдены загрузки")}).catch(e=>{console.error("Ошибка при получении данных uploaded",e)})},45e3)}catch(n){z("Ошибка при генерации токена. Попробуй ещё раз.","error")}},D=async()=>{if(!i.value){z("введи токен !","error");return}try{let e=await r.ref("tokens/"+i.value).once("value");if(e.exists()){z("ты в системе !","success"),d.value=!0,S("userToken",i.value,30),u.value=i.value;let l=e.val();s.value=l.avatar,M(i.value,l);let a=r.ref("tokens/"+i.value);a.on("value",e=>{if(e.exists()){let l=e.val();s.value=l.avatar}}),O(i.value)}else z("неверный токен !","error")}catch(t){z("Ошибка при входе. Попробуй ещё раз.","error")}},j=()=>{let e=document.createElement("input");e.type="file",e.accept="image/jpeg,image/png,image/gif,image/webp,image/heic",e.multiple=!0,e.onchange=e=>{K(e)},e.click()},K=e=>{let l=e.target.files;l&&l.length>0&&(P(l),e.target.value="")},N=e=>{k.value=0,h.value=!1;let l=e.dataTransfer.files;l&&l.length>0&&P(l)},F=()=>{k.value++,h.value=!0},H=()=>{k.value--,k.value<=0&&(h.value=!1,k.value=0)},P=e=>{$.value="";let l=["image/jpeg","image/png","image/gif","image/webp","image/heic"];for(let a=0;a<e.length;a++){let t=e[a];if(t.size>33554432){z(`Файл ${t.name} превышает 32 МБ`,"error");continue}if(!l.includes(t.type)){z(`Файл ${t.name} имеет неподдерживаемый формат. Допустимые форматы: jpg, png, gif, webp, heic`,"error");continue}V(t)}},U=process.env.VUE_APP_IMGBB,V=async e=>{let a=l({fileName:e.name,fileSize:e.size,fileType:e.type,progress:0});p.value.push(a);let t=new FormData;t.append("image",e);let n=`https://api.imgbb.com/1/upload?key=${U}`;try{let i=await o.post(n,t,{onUploadProgress(e){if(e.total){let l=Math.round(100*e.loaded/e.total);a.progress=l}}});if(i.data&&i.data.success){let s=i.data.data,v=s.medium?s.medium.url:s.url,c=r.ref("tokens/"+u.value+"/uploaded").push();await c.set({id:s.id,url:s.url,url_medium:v,delete_url:s.delete_url,uploaded_at:new Date().toISOString()}),m.value.push(e.name),1===m.value.length&&A()}else z(`Ошибка при загрузке ${e.name}`,"error")}catch(d){z(`Ошибка при загрузке ${e.name}`,"error")}finally{let $=p.value.indexOf(a);-1!==$&&p.value.splice($,1)}},W=e=>{x[e]=!x[e]},A=()=>{m.value.length>0&&setTimeout(()=>{m.value.shift(),A()},1e3)},J=e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB",L=e=>e&&e.startsWith("image/")?e.substring(6):e,Q=()=>{if(T.value>0){z("Нельзя выйти до истечения времени таймера","error");return}I("userToken"),z("ты вне системы !","success"),d.value=!1,u.value="",i.value="",s.value="",f.value=[],window.location.reload()},R=e=>{navigator.clipboard.writeText(e.url).then(()=>{e.copied=!0,setTimeout(()=>{e.copied=!1},3e3)}).catch(e=>{console.error("Ошибка при копировании ссылки:",e)})};return{token:u,inputToken:i,avatar:s,message:v,messageClass:c,isLoggedIn:d,generateToken:B,login:D,uploadMessage:$,logout:Q,tokenGenerated:g,handleFiles:K,handleDrop:N,handleDragEnter:F,handleDragLeave:H,album:f,uploads:p,formatFileSize:J,formatFileType:L,isDragged:h,openFileDialog:j,uploadMessages:m,tokenShow:_,spoilerStates:x,toggleSpoiler:W,countdownSeconds:T,copyUrl:R}};